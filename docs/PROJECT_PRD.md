# SRT转语音工具 产品需求文档(PRD)

## 1. 项目概述

### 1.1 项目规模
**中型项目** - 预计开发周期9天，代码量约2000-3000行

### 1.2 核心价值
- **解决痛点**：为视频创作者提供自动化的字幕转语音配音方案
- **主要价值**：
  - 大幅降低配音制作成本（无需人工录音）
  - 提升视频制作效率（批量处理能力）
  - 保证语音质量稳定性（专业TTS服务）
  - 支持情感控制，满足不同场景需求

### 1.3 技术可行性
- **高可行性**：所有核心技术均有成熟方案
- **关键技术点**：
  - SRT解析：使用成熟的srt库
  - TTS服务：GPT-SoVITS（本地部署）提供高质量语音合成
  - 音频处理：pydub库完全满足需求
  - 服务降级：通过策略模式实现

## 2. 功能需求（按优先级）

### 2.1 P0：核心必须功能

#### 2.1.1 基础转换功能
- SRT文件解析和验证
- 文本到语音转换（中文普通话）
- 音频文件生成（WAV格式）
- 基本命令行接口

#### 2.1.2 配置管理
- YAML配置文件支持
- 本地服务连接配置
- 默认参数配置

#### 2.1.3 错误处理
- 输入文件验证
- 服务调用失败处理
- 清晰的错误提示

### 2.2 P1：重要功能

#### 2.2.1 多服务支持
- GPT-SoVITS集成（本地部署）
- Google Gemini TTS集成（云端API，支持24种语言）
- 阿里云/讯飞TTS接口预留（后续扩展）  
- 统一的服务抽象接口
- 服务降级机制（自动切换备用服务）

#### 2.2.2 音频优化
- 音频片段智能拼接
- 语速动态调整
- 确保整体流畅度

#### 2.2.3 进度反馈
- 实时处理进度显示
- 预计剩余时间
- 处理统计信息

### 2.3 P2：可选功能

#### 2.3.1 情感控制系统
- 独立的情感配置文件
- 4种预设情感（中性、强调、友好、专业）
- 情感参数映射（语速、音调）

#### 2.3.2 高级功能
- 预览模式（处理前N条字幕）
- 调试模式（详细日志输出）
- 缓存机制（避免重复调用）

#### 2.3.3 扩展功能
- 批处理支持
- 自定义输出格式
- 服务使用统计

## 3. 技术架构

### 3.1 架构设计原则
- **简单优先**：避免过度设计，采用最直接的实现方式
- **模块化**：每个模块职责单一，便于维护和测试
- **可扩展**：预留接口，方便后续添加新的TTS服务

### 3.2 模块划分

```
srt2speech/
├── src/
│   ├── __init__.py
│   ├── cli.py              # 命令行接口 (<150行)
│   ├── config.py           # 配置管理 (<100行)
│   ├── parser/
│   │   ├── __init__.py
│   │   └── srt.py          # SRT解析 (<100行)
│   ├── tts/
│   │   ├── __init__.py
│   │   ├── base.py         # TTS抽象基类 (<50行)
│   │   ├── gptsovits.py    # GPT-SoVITS适配器 (<150行)
│   │   ├── gemini.py       # Google Gemini TTS适配器 (<150行)
│   │   └── aliyun.py       # 阿里云TTS适配器（预留） (<150行)
│   ├── audio/
│   │   ├── __init__.py
│   │   └── processor.py    # 音频处理 (<200行)
│   ├── emotion/
│   │   ├── __init__.py
│   │   └── controller.py   # 情感控制 (<100行)
│   └── utils/
│       ├── __init__.py
│       ├── logger.py       # 日志工具 (<50行)
│       └── retry.py        # 重试机制 (<50行)
├── tests/                  # 测试文件
├── docs/                   # 文档
├── config/
│   └── default.yaml        # 默认配置
└── requirements.txt        # 依赖列表
```

### 3.3 数据流向图

```
输入SRT文件
    ↓
[SRT解析器] → 提取字幕条目列表
    ↓
[情感控制器] → 应用情感配置（可选）
    ↓
[TTS服务管理器] → 选择可用服务
    ↓
[TTS适配器] → 调用具体TTS API
    ↓ (循环处理每条字幕)
[音频处理器] → 拼接音频片段
    ↓
输出WAV文件
```

### 3.4 核心接口设计

```python
# TTS服务抽象接口
class TTSService(ABC):
    @abstractmethod
    async def synthesize(self, text: str, emotion: EmotionConfig) -> AudioSegment:
        pass

# 配置数据模型
class ServiceConfig(BaseModel):
    service_name: str
    priority: int
    credentials: Dict[str, str]
    voice_settings: VoiceSettings

# 情感配置
class EmotionConfig(BaseModel):
    emotion_type: Literal["neutral", "emphasis", "friendly", "professional"]
    speech_rate: float
    pitch_shift: float
```

## 4. 开发约束

### 4.1 上下文限制考虑
- **单文件原则**：核心逻辑尽量集中，减少文件跳转
- **模块大小**：严格控制每个模块在200行以内
- **注释精简**：代码自解释，只在必要处添加注释

### 4.2 文件数量控制
- **核心文件数**：10-12个Python文件
- **配置文件**：2-3个（默认配置、示例配置）
- **文档文件**：3-4个（README、PRD、使用指南）

### 4.3 代码复杂度限制
- **函数长度**：不超过30行
- **函数参数**：不超过3个（使用配置对象）
- **嵌套层级**：不超过3层
- **循环复杂度**：单函数不超过5

### 4.4 依赖管理
- **核心依赖**：控制在10个以内
- **版本锁定**：使用精确版本号
- **最小化原则**：只引入必要的库

## 5. 实现优先级

### 5.1 第一阶段：最小可行产品（MVP）
1. 项目结构搭建
2. SRT文件解析
3. 单一TTS服务集成（GPT-SoVITS本地部署）
4. 基础音频生成
5. 简单命令行接口

### 5.2 第二阶段：核心功能完善
1. 阿里云/讯飞TTS接口设计（预留）
2. 服务降级机制
3. 配置文件支持
4. 错误处理优化
5. 进度显示

### 5.3 第三阶段：高级特性
1. 情感控制系统
2. 音频流畅度优化
3. 预览功能
4. 调试模式
5. 性能优化

## 6. 风险评估与缓解

### 6.1 技术风险
- **风险**：不同TTS服务的输出格式差异
- **缓解**：统一转换为标准WAV格式

### 6.2 性能风险
- **风险**：大文件处理时间过长
- **缓解**：实现异步处理和进度提示

### 6.3 成本风险
- **风险**：本地计算资源消耗
- **缓解**：实现缓存机制，优化模型加载

## 7. 成功指标

### 7.1 功能指标
- 支持标准SRT文件100%解析成功率
- TTS服务可用性达到99%（通过降级保证）
- 音频输出质量主观评分>4.0/5.0

### 7.2 性能指标
- 单条字幕处理时间<2秒
- 100条字幕总处理时间<3分钟
- 内存占用<500MB

### 7.3 可用性指标
- 命令行操作步骤≤3步
- 错误信息清晰度100%
- 配置文件易用性评分>4.0/5.0

## 8. 后续规划

### 8.1 功能扩展
- 支持更多语言（英语、日语）
- 集成其他云端TTS服务
- 支持更多音频格式（MP3、M4A）

### 8.2 生态建设
- 开发GUI界面
- 提供Web API服务
- 创建Docker镜像

### 8.3 社区运营
- 开源代码
- 编写详细文档
- 建立用户反馈渠道